(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5961],{55961:function(e,s,t){"use strict";var a=t(85893),n=t(67294),i=t(70822),o=t(86979),r=t(30263),l=t(39372),c=t(42495),h=t(9693),p=t(53856),d=t(53189),j=t(78895),u=t(97501),x=t(51788),m=t(88775),g=t(56064),P=t(36624),Z=t(45697),b=t.n(Z),_=t(63763),C=t(24648),k=t.n(C),v=t(11752),f=t.n(v),y=t(49872),S=t.n(y);let{publicRuntimeConfig:N}=f()(),I=e=>e?"".concat(N.backend,"user/avatar/").concat(e):"/img/default-avatar.png";class w extends n.Component{componentDidUpdate(e){e.open!==this.props.open&&this.setState({adding:!1,unionId:-1,unionRole:null,name:this.props.projectInfo.name,opensource:this.props.projectInfo.opensource,visibility:this.props.projectInfo.state,useCCEP:this.props.projectInfo.use_ccep,control:this.props.projectInfo.control,keymode:this.props.projectInfo.keymode,intro:this.props.projectInfo.intro,manual:this.props.projectInfo.manual,sumbiting:!1,rollbackModalOpen:!1})}async handleUnionAdd(e){let{unionId:s,unionRole:t}=this.state,{projectInfo:a}=this.props;if(!s||-1===s||!t){this.setState({adding:!1});return}try{await _.Z.post("project/addUnionMember",{pid:a.id,invite_user_id:s,role:t}),this.props.openSnackBar("邀请成功 (^o^)/","success"),this.setState({adding:!1})}catch(e){var n;if("can not invite yourself"===e.response.data.message){this.props.openSnackBar("不能邀请自己的啦...","warning");return}this.props.openSnackBar("邀请失败: ".concat(null===(n=e.response.data)||void 0===n?void 0:n.message),"error");return}}async handleOk(){if(1!=this.state.opensource||this.props.projectInfo.is_remix||await clipAlert("温馨提示","别针社区鼓励开源，开源作品可以获得更高的曝光度等，是否将开放状态设为“不开放”？")){if(1===this.state.visibility&&0==this.state.opensource&&!this.props.projectInfo.is_remix)return this.props.openSnackBar("请先设置源码开放等级","error");(!this.state.useCCEP||await clipAlert("提示","CCEP加密处于实验模式，打开后作品运行可能出现异常，确认打开吗？"))&&(this.setState({sumbiting:!0}),_.Z.post("".concat(this.props.manageMode?"projectManage":"project","/updateInfo"),{id:this.props.projectInfo.id,name:this.state.name,control:this.state.control||1,keymode:this.state.keymode||1,ccep:this.state.useCCEP||!1,opensource:this.props.is_remix?this.props.projectInfo.opensource+1:this.state.opensource,is_share:1===this.state.visibility,state:this.state.visibility,intro:this.state.intro,manual:this.state.manual}).then(e=>{this.props.openSnackBar("提交成功 (^o^)/","success"),this.props.onClose(!0)}).catch(e=>{let s=e.message;switch(s){case"Permission denied":this.props.openSnackBar("当前权限不足哟~先去转正吧！","warning");break;case"waiting for audit project not allowed to be public":this.props.openSnackBar("作品审核中~ 请耐心等待w","warning");break;case"banned project not allowed to be public":this.props.openSnackBar("被封禁的作品无法设置为公开哟~","warning");break;default:this.props.openSnackBar("提交失败: ".concat(e.message),"error")}this.setState({sumbiting:!1})}))}}handleChangeOpenSource(e){this.setState({opensource:parseInt(e)})}handleChangeCCEP(e){this.setState({useCCEP:e.target.checked})}handleChangeVisibility(e){this.setState({visibility:parseInt(e)})}handleChangeControl(e){this.setState({control:parseInt(e)})}handleChangeKeymode(e){this.setState({keymode:parseInt(e)})}render(){let{projectInfo:e}=this.props;return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(i.ZP,{closeButton:!0,preventClose:!0,width:"700px","aria-labelledby":"project-settings",open:this.props.open,className:k().modal,onClose:()=>this.props.onClose(!1),children:[(0,a.jsx)(i.ZP.Header,{children:(0,a.jsx)(o.Z,{id:"modal-title",size:20,children:"作品设置"})}),(0,a.jsxs)(i.ZP.Body,{children:[(0,a.jsx)(r.ZP,{placeholder:"给作品起个好听的名字吧~",initialValue:e.name,label:"作品名称",className:k().input,onChange:e=>{this.setState({name:e.target.value})}}),(0,a.jsx)("span",{className:k().label,children:"联合投稿"}),(0,a.jsxs)("div",{className:k().union,children:[(0,a.jsxs)(l.ZP.Group,{className:k().group,children:[(0,a.jsx)(l.ZP,{className:k().avatar,src:I(e.user_avatar)}),e.union_member&&0!==e.union_member.length&&e.union_member.map((e,s)=>(0,a.jsx)(c.ZP,{content:e.role,css:{transform:"translateX(-45px) translateY(-30px)",zIndex:9999},children:(0,a.jsx)(l.ZP,{className:k().avatar,src:I(e.avatar)},s)},s))]}),this.state.adding?(0,a.jsxs)("div",{className:k().add,children:[(0,a.jsx)(r.ZP,{placeholder:"输入用户 ID",type:"number",onChange:e=>{this.setState({unionId:e.target.value})}}),(0,a.jsx)(h.Z,{x:.6}),(0,a.jsx)(r.ZP,{placeholder:"输入用户角色",onChange:e=>{this.setState({unionRole:e.target.value})}}),(0,a.jsx)(h.Z,{x:.6}),(0,a.jsxs)("div",{className:k().button,children:[(0,a.jsx)(p.ZP,{auto:!0,onPress:this.handleUnionAdd,children:"邀请"}),(0,a.jsx)(h.Z,{x:.6}),(0,a.jsx)(p.ZP,{auto:!0,onPress:()=>{this.setState({adding:!1})},children:"取消"})]})]}):(0,a.jsx)(p.ZP,{auto:!0,onPress:()=>{this.setState({adding:!0})},children:"邀请"})]}),(0,a.jsx)("span",{className:k().label,children:"作品可见性"}),(0,a.jsxs)(d.ZP.Group,{initialValue:this.state.visibility,value:this.state.visibility,onChange:this.handleChangeVisibility,size:"xs",row:!0,className:k().radio,children:[(0,a.jsxs)(d.ZP,{value:0,children:["私有",(0,a.jsx)(d.ZP.Desc,{children:"只有你自己可以看到此作品"})]}),(0,a.jsxs)(d.ZP,{value:1,children:["公开",(0,a.jsx)(d.ZP.Desc,{children:"任何人都能看到此作品"})]}),this.props.manageMode&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(d.ZP,{value:2,children:["小黑屋",(0,a.jsx)(d.ZP.Desc,{children:"将此作品关入小黑屋"})]}),(0,a.jsxs)(d.ZP,{value:3,children:["待审核",(0,a.jsx)(d.ZP.Desc,{children:"加入作品审核列表"})]})]})]}),1===this.state.visibility&&!e.is_remix&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:k().label,children:"源码开放等级"}),(0,a.jsxs)(d.ZP.Group,{size:"xs",row:!0,initialValue:this.state.opensource,className:k().radio,onChange:this.handleChangeOpenSource,children:[(0,a.jsxs)(d.ZP,{value:1,children:["不开放源码",(0,a.jsx)(d.ZP.Desc,{children:"其他人无法查看或下载你的源码"})]}),(0,a.jsxs)(d.ZP,{value:2,children:["部分开放",(0,a.jsx)(d.ZP.Desc,{children:"其他人可以查看你的源码，但无法下载或改编"})]}),(0,a.jsxs)(d.ZP,{value:3,children:["完全开放",(0,a.jsx)(d.ZP.Desc,{children:"其他人可以查看你的源码，并可以下载或进行改编"})]})]})]}),(0,a.jsx)("span",{className:k().label,children:"移动端适配模式"}),(0,a.jsxs)(d.ZP.Group,{initialValue:this.state.control,onChange:this.handleChangeControl,size:"xs",row:!0,className:k().radio,children:[(0,a.jsxs)(d.ZP,{value:1,children:["无键盘",(0,a.jsx)(d.ZP.Desc,{children:"作品不适配移动端或不需要键盘"})]}),(0,a.jsxs)(d.ZP,{value:2,children:["键位转换",(0,a.jsx)(d.ZP.Desc,{children:"社区将虚拟按键转换为信号发送给作品"})]}),(0,a.jsxs)(d.ZP,{value:3,children:["作品适配",(0,a.jsx)(d.ZP.Desc,{children:"作品通过扩展自行处理虚拟按键操作"})]})]}),this.state.control>1&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:k().label,children:"键位模式"}),(0,a.jsxs)(d.ZP.Group,{size:"xs",row:!0,className:k().radio,initialValue:this.state.keymode,onChange:this.handleChangeKeymode,children:[(0,a.jsxs)(d.ZP,{value:1,children:["摇杆",(0,a.jsx)(d.ZP.Desc,{children:"通过移动摇杆位置来进行控制。作品可以获取精确的x/y坐标偏移量"})]}),(0,a.jsxs)(d.ZP,{value:2,children:["经典按键",(0,a.jsx)(d.ZP.Desc,{children:"提供WASD和空格，对作品进行进行操纵"})]}),(0,a.jsxs)(d.ZP,{value:3,children:["音游按键",(0,a.jsx)(d.ZP.Desc,{children:"提供DFJK，来击打跳动的音符"})]})]})]}),this.state.opensource<=1&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("span",{className:k().label,children:"实验性功能"}),(0,a.jsxs)("div",{className:k().switch,children:[(0,a.jsx)(j.ZP,{size:"xs",checked:this.state.useCCEP,initialChecked:this.state.useCCEP,onChange:this.handleChangeCCEP})," ",(0,a.jsx)("span",{children:"使用CCEP加密"})]})]}),(0,a.jsxs)("div",{className:k().rollback,children:[(0,a.jsx)("span",{className:k().label,children:"时光机"}),(0,a.jsx)(p.ZP,{auto:!0,onPress:()=>{this.setState({rollbackModalOpen:!0})},children:"启动"})]}),(0,a.jsx)("span",{className:k().label,children:"作品介绍（支持Markdown语法）"}),(0,a.jsx)(x.Z,{content:this.state.intro,editable:this.props.isLogin,initial:!0,lock:!0,onUpdate:e=>{this.setState({intro:e})}}),(0,a.jsx)("span",{className:k().label,children:"操作说明"}),(0,a.jsx)(x.Z,{content:this.state.manual,editable:this.props.isLogin,initial:!0,lock:!0,onUpdate:e=>{this.setState({manual:e})}})]}),(0,a.jsx)(i.ZP.Footer,{children:(0,a.jsx)(p.ZP,{auto:!0,onPress:this.handleOk,disabled:this.state.sumbiting||3===this.props.projectInfo.state&&!this.props.manageMode,children:this.state.sumbiting?(0,a.jsx)(u.ZP,{color:"currentColor",size:"sm"}):3===this.props.projectInfo.state?"审核中":"提交"})})]}),(0,a.jsx)(m.Z,{id:e.id,open:this.state.rollbackModalOpen,onClose:()=>{this.setState({rollbackModalOpen:!1})}})]})}constructor(e){super(e),S()(this,["handleOk","handleChangeOpenSource","handleChangeVisibility","handleChangeControl","handleChangeKeymode","handleChangeCCEP","handleUnionAdd"]),this.state={adding:!1,name:e.projectInfo.name,opensource:e.projectInfo.opensource,visibility:e.projectInfo.state,control:e.projectInfo.control,useCCEP:e.projectInfo.use_ccep,keymode:e.projectInfo.keymode,intro:e.projectInfo.intro,manual:e.projectInfo.manual,sumbiting:!1}}}w.propTypes={open:b().bool,onClose:b().func},s.Z=(0,g.$j)(e=>({isLogin:e.auth.user.isLogin}),e=>({openSnackBar:(s,t)=>e((0,P.jW)(t,s))}))(w)},88775:function(e,s,t){"use strict";t.d(s,{Z:function(){return w}});var a=t(85893),n=t(70822),i=t(10154),o=t(86979),r=t(67344),l=t(53856),c=t(67294),h=t(56064),p=t(36624),d=t(63763),j=t(49872),u=t.n(j),x=t(25081),m=t.n(x),g=t(65643),P=t(97501),Z=t(2970),b=t(83542),_=t.n(b),C=t(94184),k=t.n(C),v=t(44012),f=t(27484),y=t.n(f);let S=e=>{let{array:s,timestamp:t,onClick:n}=e,i=s.indexOf(t)+1;return(0,a.jsxs)(g.ZP,{bordered:!0,shadow:!1,className:_().unit,onClick:()=>{n(t)},children:[(0,a.jsxs)("span",{children:["版本: ",i]}),(0,a.jsxs)("span",{children:["发布时间: ",y().unix(t).format("L hh:mm:ss")]})]})};var N=e=>{let{data:s,isLoading:t,onClick:n}=e;return(0,a.jsx)("div",{className:_().overlay,children:(0,a.jsx)("div",{className:k()(_().list,{[_().loading]:t,[_().empty]:0===s.length&&!t}),children:t?(0,a.jsx)(P.ZP,{}):0===s.length?(0,a.jsxs)("div",{children:[(0,a.jsx)(Z.Z,{size:100,mood:"shocked",color:"#FFD882"}),(0,a.jsx)("p",{className:_().dark,children:(0,a.jsx)(v.Z,{id:"projectlist.empty",defaultMessage:"小别针的背包还有点空"})}),(0,a.jsx)("p",{className:_().dark,children:(0,a.jsx)(v.Z,{id:"projectlist.fill",defaultMessage:"快点去填补这里的空白吧"})})]}):(0,a.jsx)("div",{children:s.map((e,t)=>(0,a.jsx)(S,{array:s,timestamp:e,onClick:n},t))})})})};class I extends c.Component{componentDidUpdate(e){e.open!==this.props.open&&this.fetchHistory()}async fetchHistory(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;try{this.setState({isLoading:!0});let{data:s}=await d.Z.get("project/getTimeMachineList?project=".concat(this.props.id,"&page=").concat(e,"&limit=6"));this.setState({isLoading:!1,data:s.histories,total:s.pager.page})}catch(e){this.props.openSnackBar("error","获取历史记录时发生错误: "+e.message)}}async handleRollback(e){if(await clipAlert("回溯提示","你确定要将作品回溯至这个版本吗？")){this.setState({isLoading:!0});try{await d.Z.post("project/restoreTimeMachineBackup",{project:this.props.id,backup_id:e}),this.props.openSnackBar("success","回溯成功！"),this.props.onClose()}catch(e){this.props.openSnackBar("error","回溯失败: "+e.message),this.setState({isLoading:!0})}}}render(){return(0,a.jsxs)(n.ZP,{className:m().modal,closeButton:!0,"aria-labelledby":"rollback",open:this.props.open,onClose:this.props.onClose,children:[(0,a.jsx)(n.ZP.Header,{children:(0,a.jsxs)(i.Z,{children:[(0,a.jsx)(o.Z,{size:72,children:"️⌛"}),(0,a.jsx)(o.Z,{id:"modal-title",size:21,children:"作品时光机"}),(0,a.jsx)(o.Z,{size:14,color:"#a1a1a1",children:"找回以前的作品文件"})]})}),(0,a.jsxs)(n.ZP.Body,{children:[(0,a.jsx)(N,{isLoading:this.state.isLoading,data:this.state.data,onClick:this.handleRollback}),!this.state.isLoading&&this.state.total>1&&(0,a.jsx)(r.ZP,{initialPage:this.state.page,noMargin:!0,onChange:e=>{this.fetchHistory(e),this.setState({page:e})},total:this.state.total,className:m().pagination})]}),(0,a.jsx)(n.ZP.Footer,{children:(0,a.jsx)(l.ZP,{auto:!0,onPress:this.props.onClose,children:"关闭"})})]})}constructor(e){super(e),this.state={data:[],isLoading:!0,page:1,total:1},u()(this,["fetchHistory","handleRollback"])}}var w=(0,h.$j)(null,e=>({openSnackBar:(s,t)=>e((0,p.jW)(s,t))}))(I)},24648:function(e){e.exports={radio:"project-settings_radio__UV8Bf",label:"project-settings_label__p_Y5t",rollback:"project-settings_rollback__dZU5Q",union:"project-settings_union__mLESU",avatar:"project-settings_avatar___61PK",group:"project-settings_group__AhlPH",add:"project-settings_add__H7mML",button:"project-settings_button__PeMcl",modal:"project-settings_modal__aH3_S",input:"project-settings_input__MA7gm",textarea:"project-settings_textarea__DV8xN",switch:"project-settings_switch__x9DAU"}},25081:function(e){e.exports={modal:"rollback-modal_modal__BgXRu"}},83542:function(e){e.exports={overlay:"rollback-list_overlay__3Sw4g",loading:"rollback-list_loading__S8bOY",empty:"rollback-list_empty__mH7iN",unit:"rollback-list_unit__SrteX"}}}]);